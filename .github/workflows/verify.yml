# Generated by Copilot Jason v3.4
# SecurityStatic v3.4 - Live Verification Workflow
name: ğŸ” Verify Live Deployment

on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify:
    name: ğŸŒ Live Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ§® Compute Local SRI Hash
        id: localhash
        run: |
          echo "ğŸ”¢ Berechne SHA384 Hash der lokalen minified files..."
          
          if [ -f "dist/scripts/security.static.min.js" ]; then
            LOCAL_HASH=$(openssl dgst -sha384 -binary dist/scripts/security.static.min.js | openssl base64 -A)
            echo "local_hash=$LOCAL_HASH" >> $GITHUB_ENV
            echo "âœ… Lokaler SRI Hash: sha384-$LOCAL_HASH"
          else
            echo "âŒ Lokale dist/scripts/security.static.min.js nicht gefunden"
            exit 1
          fi

      - name: ğŸŒ Fetch Live JavaScript File
        id: fetchlive
        run: |
          echo "ğŸŒ Lade Live-Version von GitHub Pages herunter..."
          
          # Warte 30 Sekunden fÃ¼r GitHub Pages Propagation
          echo "â³ Warte 30s auf GitHub Pages Update..."
          sleep 30
          
          # Download mit Retry-Logik
          for i in {1..3}; do
            if curl -sL "https://mtoTheSchlee.github.io/raetzel_winter_2025/scripts/security.static.min.js" -o live.min.js; then
              echo "âœ… Live-Datei erfolgreich heruntergeladen (Versuch $i)"
              break
            else
              echo "âš ï¸ Download-Versuch $i fehlgeschlagen, retry in 10s..."
              sleep 10
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ Download nach 3 Versuchen fehlgeschlagen"
              exit 1
            fi
          done
          
          # Berechne Live Hash
          LIVE_HASH=$(openssl dgst -sha384 -binary live.min.js | openssl base64 -A)
          echo "live_hash=$LIVE_HASH" >> $GITHUB_ENV
          echo "ğŸŒ Live SRI Hash: sha384-$LIVE_HASH"

      - name: ğŸ” Compare SRI Hashes
        id: compare
        run: |
          echo "ğŸ“Š Hash-Vergleich:"
          echo "  Lokaler Hash:  sha384-$local_hash"
          echo "  Live Hash:     sha384-$live_hash"
          
          if [ "$local_hash" = "$live_hash" ]; then
            echo "âœ… SRI Verification SUCCESS â€“ Live version matches local build!"
            echo "integrity_check=PASSED" >> $GITHUB_ENV
          else
            echo "âŒ SRI MISMATCH! Live version differs from local build!"
            echo "integrity_check=FAILED" >> $GITHUB_ENV
            exit 1
          fi

      - name: ğŸ”— Verify Live URL Status & Performance
        id: status
        run: |
          echo "ğŸŒ PrÃ¼fe Erreichbarkeit und Performance..."
          
          # HTTP Status Check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://mtoTheSchlee.github.io/raetzel_winter_2025/")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "https://mtoTheSchlee.github.io/raetzel_winter_2025/")
          
          echo "ğŸ” HTTP Status: $HTTP_CODE"
          echo "âš¡ Response Time: ${RESPONSE_TIME}s"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Live website reachable (HTTP 200)"
            echo "http_status=OK" >> $GITHUB_ENV
          else
            echo "âŒ Live site returned status: $HTTP_CODE"
            echo "http_status=FAILED" >> $GITHUB_ENV
            exit 1
          fi
          
          # Performance Check
          if (( $(echo "$RESPONSE_TIME < 3.0" | bc -l) )); then
            echo "âœ… Performance OK (<3s response time)"
            echo "performance=GOOD" >> $GITHUB_ENV
          else
            echo "âš ï¸ Slow response time: ${RESPONSE_TIME}s"
            echo "performance=SLOW" >> $GITHUB_ENV
          fi

      - name: ğŸ§ª Live JavaScript Functionality Test
        id: jstest
        run: |
          echo "ğŸ§ª Teste Live JavaScript FunktionalitÃ¤t..."
          
          # Download und teste JavaScript
          curl -sL "https://mtoTheSchlee.github.io/raetzel_winter_2025/scripts/security.static.min.js" -o test.min.js
          
          # Basic Syntax Check
          node -c test.min.js && echo "âœ… JavaScript Syntax OK" || (echo "âŒ JavaScript Syntax Error" && exit 1)
          
          # Size Check (sollte ~7KB sein)
          FILE_SIZE=$(wc -c < test.min.js)
          echo "ğŸ“¦ Live file size: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -gt 5000 ] && [ "$FILE_SIZE" -lt 10000 ]; then
            echo "âœ… File size within expected range (5-10KB)"
            echo "file_size=OK" >> $GITHUB_ENV
          else
            echo "âš ï¸ Unexpected file size: $FILE_SIZE bytes"
            echo "file_size=WARNING" >> $GITHUB_ENV
          fi

      - name: ğŸ“Š Generate Verification Report
        if: always()
        run: |
          echo "# ğŸ“‹ SecurityStatic v3.4 Live Verification Report" > verification_report.md
          echo "" >> verification_report.md
          echo "**Timestamp**: $(date -u)" >> verification_report.md
          echo "**Commit**: $(git rev-parse --short HEAD)" >> verification_report.md
          echo "**Live URL**: https://mtoTheSchlee.github.io/raetzel_winter_2025/" >> verification_report.md
          echo "" >> verification_report.md
          echo "## ğŸ” Verification Results" >> verification_report.md
          echo "" >> verification_report.md
          echo "| Check | Status | Details |" >> verification_report.md
          echo "|-------|--------|---------|" >> verification_report.md
          echo "| SRI Integrity | ${integrity_check:-UNKNOWN} | Local vs Live hash comparison |" >> verification_report.md
          echo "| HTTP Status | ${http_status:-UNKNOWN} | Website accessibility |" >> verification_report.md
          echo "| Performance | ${performance:-UNKNOWN} | Response time analysis |" >> verification_report.md
          echo "| File Size | ${file_size:-UNKNOWN} | JavaScript file validation |" >> verification_report.md
          echo "" >> verification_report.md
          echo "## ğŸ” SRI Hashes" >> verification_report.md
          echo "" >> verification_report.md
          echo "- **Local**: sha384-${local_hash:-N/A}" >> verification_report.md
          echo "- **Live**: sha384-${live_hash:-N/A}" >> verification_report.md
          echo "" >> verification_report.md
          
          cat verification_report.md

      - name: ğŸ‰ Verification Success
        if: success()
        run: |
          echo "ğŸ‰ SecurityStatic v3.4 Live Verification ERFOLGREICH!"
          echo ""
          echo "âœ… Alle Checks bestanden:"
          echo "  â€¢ SRI Integrity: VERIFIED"
          echo "  â€¢ HTTP Status: 200 OK" 
          echo "  â€¢ Performance: Under 3s"
          echo "  â€¢ JavaScript: Valid"
          echo ""
          echo "ğŸ”— Live Demo: https://mtoTheSchlee.github.io/raetzel_winter_2025/"
          echo "ğŸ“… Verified: $(date -u)"