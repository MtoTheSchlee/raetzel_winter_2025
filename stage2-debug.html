<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage-2 Debug Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
            background: #2a1a1a;
        }
        .warning {
            border-left-color: #ff9800;
            background: #2a2220;
        }
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn.warning {
            background: #ff9800;
        }
        .btn.danger {
            background: #f44336;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
        #systemStatus {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Stage-2 Debug & Test Console</h1>
    
    <div id="systemStatus">
        <h3>System Status</h3>
        <div id="statusDisplay">Lade System-Status...</div>
    </div>

    <div class="test-section">
        <h3>üîó Direkte URLs testen</h3>
        <button class="btn" onclick="testURL('/?day=2&stage=2&qr=test')">Test: Tag 2 Stage-2 mit QR</button>
        <button class="btn" onclick="testURL('/?day=2')">Test: Tag 2 Normal</button>
        <button class="btn warning" onclick="testURL('/?day=2&stage=2')">Test: Stage-2 ohne QR (sollte fehlen)</button>
    </div>

    <div class="test-section">
        <h3>üß™ QR-System Tests</h3>
        <button class="btn" onclick="testQRCode('test')">Test QR: test</button>
        <button class="btn" onclick="testQRCode('invalidcode')">Test QR: invalid</button>
        <button class="btn" onclick="testQRCode('day2stage2test')">Test QR: day2stage2test</button>
    </div>

    <div class="test-section">
        <h3>üéØ Modal Tests</h3>
        <button class="btn" onclick="testModalSystem()">Modal System testen</button>
        <button class="btn" onclick="testStage2Modal()">Stage-2 Modal √∂ffnen</button>
        <button class="btn danger" onclick="closeTestModal()">Modal schlie√üen</button>
    </div>

    <div class="test-section">
        <h3>üíæ Storage & Data Tests</h3>
        <button class="btn" onclick="testLocalStorage()">LocalStorage testen</button>
        <button class="btn" onclick="testJSONLoad()">JSON Daten laden</button>
        <button class="btn" onclick="testAnswerSystem()">Antwort-System testen</button>
    </div>

    <div class="console-output" id="testOutput"></div>

    <!-- Modal aus index.html -->
    <div id="puzzle-modal" class="modal" style="display: none;">
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Test Modal</h3>
                <span class="modal__close" onclick="closeTestModal()">&times;</span>
            </div>
            <div class="modal__body">
                <p>Modal Content wird hier geladen...</p>
            </div>
            <div class="modal__footer">
                <button type="button" onclick="closeTestModal()">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Lade alle App-Scripts -->
    <script src="scripts/utils/AnswersStore.js"></script>
    <script src="scripts/calendar.logic.js"></script>
    <script src="scripts/main.js"></script>

    <script>
        // Verbesserte Console-Funktionen mit HTML-Output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function logToOutput(type, ...args) {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'log': 'üìù',
                'error': '‚ùå',
                'warn': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');
            
            output.innerHTML += `<div style="color: ${type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#6bcf7f'}">[${timestamp}] ${prefix[type]} ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            
            // Rufe auch original console auf
            originalConsole[type](...args);
        }

        // √úberschreibe console methods
        console.log = (...args) => logToOutput('log', ...args);
        console.error = (...args) => logToOutput('error', ...args);
        console.warn = (...args) => logToOutput('warn', ...args);
        console.info = (...args) => logToOutput('info', ...args);

        // System-Status Checker
        function updateSystemStatus() {
            const statusDiv = document.getElementById('statusDisplay');
            let status = [];

            // Check if main components are loaded
            status.push(typeof AnswersStore !== 'undefined' ? 
                '<span class="status-indicator status-ok"></span>AnswersStore: ‚úÖ Geladen' :
                '<span class="status-indicator status-error"></span>AnswersStore: ‚ùå Fehlt');

            status.push(typeof CalendarLogic !== 'undefined' ? 
                '<span class="status-indicator status-ok"></span>CalendarLogic: ‚úÖ Geladen' :
                '<span class="status-indicator status-error"></span>CalendarLogic: ‚ùå Fehlt');

            status.push(typeof MainApp !== 'undefined' ? 
                '<span class="status-indicator status-ok"></span>MainApp: ‚úÖ Geladen' :
                '<span class="status-indicator status-error"></span>MainApp: ‚ùå Fehlt');

            // Check LocalStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                status.push('<span class="status-indicator status-ok"></span>LocalStorage: ‚úÖ Funktioniert');
            } catch (e) {
                status.push('<span class="status-indicator status-error"></span>LocalStorage: ‚ùå Fehler');
            }

            // Check Modal
            const modal = document.getElementById('puzzle-modal');
            status.push(modal ? 
                '<span class="status-indicator status-ok"></span>Modal: ‚úÖ Vorhanden' :
                '<span class="status-indicator status-error"></span>Modal: ‚ùå Fehlt');

            statusDiv.innerHTML = status.join('<br>');
        }

        // Test Funktionen
        function testURL(url) {
            console.log(`üîó Teste URL: ${url}`);
            try {
                // Simuliere URL-Parameter
                const urlObj = new URL(url, window.location.origin);
                const params = new URLSearchParams(urlObj.search);
                
                console.log('üìã URL Parameter:', Object.fromEntries(params.entries()));
                
                // Teste MainApp URL-Handling
                if (typeof MainApp !== 'undefined' && MainApp.instance) {
                    console.log('üéØ MainApp verf√ºgbar, teste Verarbeitung...');
                    MainApp.instance.handleURLParams(params);
                } else {
                    console.warn('‚ö†Ô∏è MainApp nicht verf√ºgbar');
                }
                
            } catch (error) {
                console.error('‚ùå URL Test Fehler:', error);
            }
        }

        function testQRCode(code) {
            console.log(`üîç Teste QR-Code: ${code}`);
            
            try {
                if (typeof MainApp !== 'undefined' && MainApp.instance) {
                    MainApp.instance.handleStage2QRCode(2, code);
                } else {
                    console.warn('‚ö†Ô∏è MainApp nicht verf√ºgbar f√ºr QR-Test');
                }
            } catch (error) {
                console.error('‚ùå QR-Code Test Fehler:', error);
            }
        }

        function testModalSystem() {
            console.log('üé≠ Teste Modal System...');
            
            const modal = document.getElementById('puzzle-modal');
            if (!modal) {
                console.error('‚ùå Modal nicht gefunden!');
                return;
            }

            console.log('‚úÖ Modal Element gefunden');
            
            // Test Modal-Selektoren
            const title = modal.querySelector('.modal__title');
            const body = modal.querySelector('.modal__body');
            const footer = modal.querySelector('.modal__footer');
            
            console.log('üîç Modal Elemente:', {
                title: title ? '‚úÖ Gefunden' : '‚ùå Fehlt',
                body: body ? '‚úÖ Gefunden' : '‚ùå Fehlt',
                footer: footer ? '‚úÖ Gefunden' : '‚ùå Fehlt'
            });

            // Teste CalendarLogic Modal-Funktionen
            if (typeof CalendarLogic !== 'undefined') {
                console.log('üéØ CalendarLogic verf√ºgbar, teste Modal-Funktionen...');
                try {
                    CalendarLogic.showModal();
                } catch (error) {
                    console.error('‚ùå Modal Show Fehler:', error);
                }
            }
        }

        function testStage2Modal() {
            console.log('üéØ Teste Stage-2 Modal...');
            
            try {
                if (typeof CalendarLogic !== 'undefined') {
                    CalendarLogic.renderStage2HintView(2);
                } else {
                    console.error('‚ùå CalendarLogic nicht verf√ºgbar');
                }
            } catch (error) {
                console.error('‚ùå Stage-2 Modal Fehler:', error);
            }
        }

        function closeTestModal() {
            console.log('üö™ Schlie√üe Modal...');
            
            const modal = document.getElementById('puzzle-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal geschlossen');
            }
            
            if (typeof CalendarLogic !== 'undefined') {
                try {
                    CalendarLogic.closeModal();
                } catch (error) {
                    console.warn('‚ö†Ô∏è CalendarLogic closeModal Fehler:', error);
                }
            }
        }

        function testLocalStorage() {
            console.log('üíæ Teste LocalStorage...');
            
            try {
                // Test basic storage
                localStorage.setItem('test_key', 'test_value');
                const value = localStorage.getItem('test_key');
                console.log('‚úÖ LocalStorage schreibt/liest:', value === 'test_value');
                
                // Test AnswersStore if available
                if (typeof AnswersStore !== 'undefined') {
                    console.log('üéØ Teste AnswersStore...');
                    const store = new AnswersStore();
                    console.log('üìã Aktuelle Antworten:', store.getAllAnswers());
                    
                    // Test store answer
                    store.storeAnswer(99, 'test_answer');
                    console.log('üíæ Test Antwort gespeichert');
                    console.log('üìã Antworten nach Test:', store.getAllAnswers());
                } else {
                    console.warn('‚ö†Ô∏è AnswersStore nicht verf√ºgbar');
                }
                
                localStorage.removeItem('test_key');
                console.log('üóëÔ∏è Test-Daten bereinigt');
                
            } catch (error) {
                console.error('‚ùå LocalStorage Test Fehler:', error);
            }
        }

        function testJSONLoad() {
            console.log('üìÑ Teste JSON Daten laden...');
            
            fetch('/public/puzzles/raetsel/day-02.json')
                .then(response => {
                    console.log('üåê HTTP Response Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ JSON erfolgreich geladen:');
                    console.log('üìã Stage-2 Daten:', data.stage2 || 'Nicht gefunden');
                    
                    if (data.stage2) {
                        console.log('üéØ K√ºchenklaus Daten:', {
                            headline: data.stage2.headline,
                            hasHint: !!data.stage2.hint_html,
                            answerMeta: data.stage2.answer_meta
                        });
                    }
                })
                .catch(error => {
                    console.error('‚ùå JSON Lade-Fehler:', error);
                });
        }

        function testAnswerSystem() {
            console.log('üéØ Teste Antwort-System...');
            
            if (typeof CalendarLogic !== 'undefined') {
                try {
                    // Simuliere Antwort-Eingabe
                    console.log('üìù Simuliere Antwort "plasmafilter"...');
                    
                    // Test answer validation
                    const testAnswers = ['plasmafilter', 'plasma-filter', 'PLASMAFILTER', 'wronganswer'];
                    testAnswers.forEach(answer => {
                        console.log(`üß™ Teste Antwort: "${answer}"`);
                        // Here would be the actual validation logic
                    });
                    
                } catch (error) {
                    console.error('‚ùå Antwort-System Test Fehler:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è CalendarLogic nicht verf√ºgbar f√ºr Antwort-Tests');
            }
        }

        // Auto-Start
        window.addEventListener('load', () => {
            console.log('üöÄ Debug Console gestartet');
            updateSystemStatus();
            
            // Check URL parameters
            const params = new URLSearchParams(window.location.search);
            if (params.has('day') || params.has('stage') || params.has('qr')) {
                console.log('üîó URL Parameter erkannt:', Object.fromEntries(params.entries()));
                console.log('üéØ Starte automatischen Test...');
                
                // Wait a bit for scripts to load
                setTimeout(() => {
                    if (typeof MainApp !== 'undefined' && MainApp.instance) {
                        MainApp.instance.handleURLParams(params);
                    }
                }, 1000);
            }
        });

        // Update status every few seconds
        setInterval(updateSystemStatus, 5000);
    </script>
</body>
</html>