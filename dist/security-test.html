<!DOCTYPE html>
<html lang="de">
<head>
    <base href="/raetzel_winter_2025/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Test - Winter Rallye 2025</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” Security.static.js Test Suite</h1>
        <p>Diese Seite testet alle wichtigen Sicherheitsfunktionen der Winter Rallye 2025.</p>
        
        <div id="test-results"></div>
        
        <button onclick="runTests()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
            ğŸš€ Tests ausfÃ¼hren
        </button>
    </div>

    <script src="./scripts/security.static.js"></script>
    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="info">Tests werden ausgefÃ¼hrt...</div>';
            
            const results = [];
            
            try {
                // Test 1: Sicherheitsmodul verfÃ¼gbar
                if (window.SecurityStatic) {
                    results.push({ test: 'SecurityStatic verfÃ¼gbar', status: 'success', details: 'Modul geladen' });
                } else {
                    results.push({ test: 'SecurityStatic verfÃ¼gbar', status: 'error', details: 'Modul nicht gefunden' });
                    return displayResults(results);
                }
                
                // Test 2: HMAC-SHA256 Funktion
                try {
                    const hmac = await window.SecurityStatic.hmacSHA256('test-key', 'test-message');
                    if (hmac && hmac instanceof Uint8Array) {
                        results.push({ test: 'HMAC-SHA256', status: 'success', details: `Hash generiert: ${hmac.length} bytes` });
                    } else {
                        results.push({ test: 'HMAC-SHA256', status: 'error', details: 'UngÃ¼ltiger Hash-Typ' });
                    }
                } catch (error) {
                    results.push({ test: 'HMAC-SHA256', status: 'error', details: error.message });
                }
                
                // Test 3: Answer Hashing
                try {
                    const answerHash = await window.SecurityStatic.hashAnswer('test-antwort');
                    if (answerHash && typeof answerHash === 'string') {
                        results.push({ test: 'Answer Hashing', status: 'success', details: `Hash: ${answerHash.substring(0, 16)}...` });
                    } else {
                        results.push({ test: 'Answer Hashing', status: 'error', details: 'Kein gÃ¼ltiger String-Hash' });
                    }
                } catch (error) {
                    results.push({ test: 'Answer Hashing', status: 'error', details: error.message });
                }
                
                // Test 4: Input Validation
                try {
                    const validation = window.SecurityStatic.validateInput('Test eingabe', 'string', { maxLength: 50 });
                    if (validation && validation.valid) {
                        results.push({ test: 'Input Validation', status: 'success', details: `Sanitized: "${validation.sanitized}"` });
                    } else {
                        results.push({ test: 'Input Validation', status: 'error', details: 'Validation fehlgeschlagen' });
                    }
                } catch (error) {
                    results.push({ test: 'Input Validation', status: 'error', details: error.message });
                }
                
                // Test 5: Rate Limiting
                try {
                    const canProceed1 = window.SecurityStatic.checkRateLimit('qr_scan', 'test-user');
                    const canProceed2 = window.SecurityStatic.checkRateLimit('qr_scan', 'test-user');
                    
                    if (typeof canProceed1 === 'boolean') {
                        results.push({ test: 'Rate Limiting', status: 'success', details: `Erste Anfrage: ${canProceed1}, Zweite: ${canProceed2}` });
                    } else {
                        results.push({ test: 'Rate Limiting', status: 'error', details: 'Kein Boolean-RÃ¼ckgabe' });
                    }
                } catch (error) {
                    results.push({ test: 'Rate Limiting', status: 'error', details: error.message });
                }
                
                // Test 6: XSS Protection
                try {
                    const xssInput = '&lt;script&gt;alert("xss")&lt;/script&gt;test';
                    const sanitized = window.SecurityStatic.sanitizeInput(xssInput);
                    
                    if (sanitized && !sanitized.includes('script')) {
                        results.push({ test: 'XSS Protection', status: 'success', details: `Sanitized: "${sanitized}"` });
                    } else {
                        results.push({ test: 'XSS Protection', status: 'error', details: 'XSS nicht blockiert' });
                    }
                } catch (error) {
                    results.push({ test: 'XSS Protection', status: 'error', details: error.message });
                }
                
                // Test 7: Crypto Support
                try {
                    const cryptoSupported = window.SecurityStatic.checkCryptoSupport();
                    results.push({ 
                        test: 'Crypto Support', 
                        status: cryptoSupported ? 'success' : 'info', 
                        details: cryptoSupported ? 'Web Crypto API verfÃ¼gbar' : 'Fallback-Modus aktiv' 
                    });
                } catch (error) {
                    results.push({ test: 'Crypto Support', status: 'error', details: error.message });
                }
                
            } catch (error) {
                results.push({ test: 'Allgemein', status: 'error', details: error.message });
            }
            
            displayResults(results);
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.status}`;
                div.innerHTML = `
                    <strong>${result.test}</strong>: 
                    ${result.status === 'success' ? 'âœ…' : result.status === 'error' ? 'âŒ' : 'â„¹ï¸'} 
                    ${result.details}
                `;
                resultsDiv.appendChild(div);
            });
            
            // Zusammenfassung
            const total = results.length;
            const passed = results.filter(r => r.status === 'success').length;
            const failed = results.filter(r => r.status === 'error').length;
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-result ${failed === 0 ? 'success' : 'info'}`;
            summaryDiv.innerHTML = `
                <strong>ğŸ“Š Test-Zusammenfassung:</strong> ${passed}/${total} Tests erfolgreich
                ${failed > 0 ? `, ${failed} Fehler` : ' - Alle Tests bestanden! ğŸ‰'}
            `;
            resultsDiv.appendChild(summaryDiv);
        }
        
        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 1000);
        });
    </script>
</body>
</html>